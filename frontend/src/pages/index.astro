---
import MainLayout from '../layouts/MainLayout.astro';
import { getEvents, getGlobalSettings } from '../lib/api';

// 1. Daten laden
const [settings, allEvents] = await Promise.all([
  getGlobalSettings(),
  getEvents()
]);

const ASSET_URL = 'http://localhost:8055/assets'; 

/** * DEBUG-LOG (Nur im Terminal sichtbar) */
console.log("--- API CHECK ---");
allEvents.forEach(e => {
  console.log(`Event: ${e.title} | Highlight-Feld: ${e.is_highlight}`);
});

// 2. Highlight Logik
const highlightEvent = allEvents.find(e => e.is_highlight === true);

// 3. Die nächsten 3 Events (Highlight ausschließen)
const upcomingEvents = allEvents
  .filter(e => e.id !== highlightEvent?.id)
  .slice(0, 3);

const heroHeadline = settings?.hero_headline || "Kultur verbindet.<br> <span class=\"pr-2 bg-clip-text text-transparent bg-gradient-to-r from-rose-600 to-orange-400\">Soziales</span> stärkt.";
---

<MainLayout title="Startseite">
    
    <style is:inline>
        .home-content { visibility: hidden; }
        html.home-ready .home-content { visibility: visible; }
    </style>
    <script is:inline>
        (function () {
            const reveal = () => document.documentElement.classList.add('home-ready');
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                reveal();
                return;
            }
            window.addEventListener('DOMContentLoaded', reveal, { once: true });
            setTimeout(reveal, 1500);
        })();
    </script>
    <noscript><style>.home-content{visibility:visible}</style></noscript>

    <div class="home-content">
    
    <section class="relative z-10 px-6 sm:px-10 pt-32 pb-20 bg-white">
        <div class="max-w-6xl">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-50 border border-slate-200 text-xs font-bold text-rose-500 mb-8 uppercase tracking-widest shadow-sm">
                <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                Seit 1983
            </div>
            <h1 class="text-5xl sm:text-7xl lg:text-8xl font-display font-extrabold text-slate-900 tracking-tighter leading-[0.9] mb-12" set:html={heroHeadline}></h1>
            <p class="text-xl text-slate-500 max-w-2xl leading-relaxed border-l-4 border-rose-500 pl-8 font-medium">
                {settings?.hero_subline || "Ein offener Raum für analoge Begegnung und digitale Identität mitten in Graz."}
            </p>
        </div>
    </section>

    <section class="px-6 sm:px-10 pb-24 bg-white">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 md:grid-rows-2 gap-6 h-auto md:h-[700px]">
                
                {highlightEvent ? (
                    <a href={`/events/${highlightEvent.slug}`} class="md:col-span-2 md:row-span-2 relative group rounded-[32px] overflow-hidden bg-slate-900 shadow-xl">
                        {highlightEvent.image ? (
                            <img 
                                src={`${ASSET_URL}/${highlightEvent.image}`} 
                                class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:scale-105 transition duration-1000" 
                                alt={highlightEvent.title} 
                            />
                        ) : (
                            <div class="absolute inset-0 flex items-center justify-center bg-slate-800 text-slate-500 italic font-display">Bild folgt</div>
                        )}
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/20 to-transparent"></div>
                        <div class="absolute bottom-0 left-0 p-8 md:p-12 text-white">
                            <span class="inline-block px-3 py-1 rounded-full bg-rose-600 text-[10px] font-bold uppercase mb-4 shadow-lg tracking-widest">Highlight</span>
                            <h2 class="text-3xl md:text-5xl font-display font-bold leading-tight mb-4 tracking-tight">{highlightEvent.title}</h2>
                            <p class="text-slate-300 line-clamp-2 max-w-md font-medium mb-6">{highlightEvent.description?.replace(/<[^>]*>?/gm, '')}</p>
                            <span class="font-bold flex items-center gap-2 text-rose-400">Mehr erfahren <i class="fa-solid fa-arrow-right text-xs"></i></span>
                        </div>
                    </a>
                ) : (
                    <div class="md:col-span-2 md:row-span-2 bg-slate-50 rounded-[32px] flex flex-col items-center justify-center border-2 border-dashed border-slate-200 p-12 text-center transition-colors">
                        <i class="fa-solid fa-star-half-stroke text-3xl text-slate-200 mb-4"></i>
                        <p class="text-slate-400 font-bold uppercase tracking-widest text-xs">Kein Event als Highlight markiert</p>
                    </div>
                )}

                {upcomingEvents.map((event, index) => (
                    <a href={`/events/${event.slug}`} class={`relative group rounded-[32px] overflow-hidden bg-slate-900 border border-slate-900/10 hover:shadow-xl transition-all ${index === 2 ? 'md:col-span-2 md:row-span-1' : 'md:col-span-1 md:row-span-1'}`}>
                        {event.image ? (
                            <img 
                                src={`${ASSET_URL}/${event.image}`} 
                                class="absolute inset-0 w-full h-full object-cover opacity-70 group-hover:scale-105 transition duration-1000" 
                                alt={event.title} 
                            />
                        ) : (
                            <div class="absolute inset-0 flex items-center justify-center bg-slate-800 text-slate-500 italic font-display">Bild folgt</div>
                        )}

                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/25 to-transparent"></div>

                        <div class="relative z-10 p-6 flex flex-col h-full">
                            <div class="flex justify-between items-start gap-4">
                                <span class="text-[10px] font-bold text-rose-200 uppercase tracking-widest bg-slate-900/40 px-2.5 py-1 rounded-full backdrop-blur">
                                    {new Date(event.start_date).toLocaleDateString('de-DE', { day: '2-digit', month: 'short' })}
                                </span>
                                <div class="flex gap-1 flex-wrap justify-end">
                                    {event.event_categories?.map(cat => (
                                        <span class="px-2 py-0.5 rounded bg-white/10 text-slate-100 text-[8px] font-bold uppercase backdrop-blur">
                                            {cat.event_categories_id?.name}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            <div class="mt-auto">
                                <h3 class="text-lg font-display font-bold text-white group-hover:text-rose-200 transition-colors line-clamp-2 leading-tight tracking-tight">
                                    {event.title}
                                </h3>
                                <div class="mt-4 flex items-center gap-2 text-[10px] font-bold text-slate-200 uppercase tracking-widest">
                                    Details <i class="fa-solid fa-arrow-right-long text-rose-300"></i>
                                </div>
                            </div>
                        </div>
                    </a>
                ))}
                
                <a href="/events" class="md:col-span-1 md:row-span-1 bg-rose-600 rounded-[32px] p-8 flex flex-col justify-center items-center text-center text-white group hover:bg-slate-900 transition-all shadow-lg">
                    <i class="fa-solid fa-layer-group text-3xl mb-4 group-hover:rotate-12 transition-transform"></i>
                    <span class="text-xl font-display font-bold leading-tight tracking-tighter">Alle <br>Veranstaltungen</span>
                </a>

            </div>
        </div>
    </section>

    <section class="px-6 sm:px-10 py-24 bg-slate-50 border-y border-slate-100">
        <div class="max-w-6xl mx-auto">
            <div class="grid lg:grid-cols-2 gap-16 items-center">
                <div class="relative rounded-[32px] overflow-hidden shadow-2xl ring-8 ring-white bg-slate-200 aspect-video">
                    <img src="https://images.unsplash.com/photo-1529156069898-49953e39b3ac?q=80&w=1600&fit=crop" class="w-full h-full object-cover" alt="Community">
                </div>
                <div>
                    <span class="text-rose-500 font-bold tracking-widest uppercase text-xs mb-4 block underline decoration-rose-500 decoration-2 underline-offset-4 tracking-widest">Die Brücke Graz</span>
                    <h2 class="text-4xl md:text-5xl font-display font-bold mb-8 leading-tight text-slate-900 tracking-tighter">Beratung, Hilfe &<br>offene Kultur.</h2>
                    <div class="grid gap-6">
                        <div class="p-6 bg-white rounded-2xl border border-slate-200/60 shadow-sm">
                            <h3 class="text-xl font-bold text-slate-900 mb-2 font-display">Unbürokratische Sozialarbeit</h3>
                            <p class="text-slate-500 font-medium leading-relaxed">Wir unterstützen bei Behördenwegen, Formularen und Krisen. Kostenlos und auf Augenhöhe.</p>
                        </div>
                        <div class="p-6 bg-white rounded-2xl border border-slate-200/60 shadow-sm">
                            <h3 class="text-xl font-bold text-slate-900 mb-2 font-display">Subkulturelle Bühne</h3>
                            <p class="text-slate-500 font-medium leading-relaxed">Ein Ort für Grazer Künstler, Musiker und Denker. Vielfalt ist unsere Stärke.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="px-6 sm:px-10 py-24 bg-white">
        <div class="bg-slate-900 rounded-[40px] p-12 sm:p-20 text-white text-center relative overflow-hidden shadow-2xl">
            <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-rose-900/20 rounded-full blur-3xl opacity-50 pointer-events-none -translate-y-1/2 translate-x-1/2"></div>

            <div class="relative z-10 max-w-2xl mx-auto">
                <h2 class="text-4xl sm:text-7xl font-display font-extrabold tracking-tighter mb-8 leading-[0.9]">
                    Mach mit.<br><span class="text-rose-500">Werde Teil davon.</span>
                </h2>
                <div class="flex flex-wrap justify-center gap-4">
                    <a href="/contact" class="bg-rose-600 hover:bg-white hover:text-slate-900 px-10 py-4 rounded-full font-bold transition-all shadow-lg text-lg transform hover:-translate-y-1">Schreib uns</a>
                    <a href="/about" class="bg-white/10 hover:bg-white/20 px-10 py-4 rounded-full font-bold transition-all border border-white/10 text-lg">Über den Verein</a>
                </div>
            </div>
        </div>
    </section>

    </div>
</MainLayout>