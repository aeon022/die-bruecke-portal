---
import Layout from '../../layouts/layout.astro'; // Auf Kleinschreibung achten (layout.astro)
import { getEventBySlug } from '../../lib/api';

// 1. Slug aus der URL holen
const { slug } = Astro.params;

let event = null;
try {
  // Wir nutzen jetzt unsere saubere API-Funktion
  event = await getEventBySlug(slug);
} catch (e) {
  console.error(`âŒ Fehler beim Laden des Events "${slug}":`, e);
}

// 2. Fallback: Wenn kein Event gefunden wurde -> 404
if (!event) {
  return Astro.redirect('/404');
}

// Bild URL Helper
// TODO: SpÃ¤ter in eine zentrale Config/ENV auslagern
const ASSET_URL = 'http://localhost:8055/assets';
const imageUrl = event.image ? `${ASSET_URL}/${event.image}` : null;
---

<Layout>
  <article class="max-w-4xl mx-auto bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 mt-8 mb-12">
    
    {imageUrl ? (
      <img src={imageUrl} alt={event.title} class="w-full h-64 md:h-96 object-cover" />
    ) : (
      <div class="w-full h-64 bg-gray-100 flex items-center justify-center text-gray-400">
        Kein Bild vorhanden
      </div>
    )}

    <div class="p-8 md:p-12">
      <div class="mb-8 border-b pb-8">
        <h1 class="text-3xl md:text-5xl font-bold text-gray-900 mb-4">{event.title}</h1>
        
        <div class="flex flex-wrap gap-4 text-sm font-medium text-gray-500">
          
          {/* FIX: toLocaleString statt toLocaleDateString nutzen! */}
          <span class="flex items-center gap-1 text-blue-600">
            ğŸ“… {new Date(event.start_date).toLocaleString('de-DE', { dateStyle: 'full', timeStyle: 'short' })} Uhr
          </span>
          
          {event.location && (
            <span class="flex items-center gap-1">
              ğŸ“ {event.location}
            </span>
          )}

          {/* Kategorie anzeigen (wenn vorhanden) */}
          {event.category && typeof event.category !== 'number' && (
            <span class="flex items-center gap-1 px-2 py-0.5 rounded text-white" 
                  style={`background-color: ${event.category.color || '#666'}`}>
              ğŸ·ï¸ {event.category.name}
            </span>
          )}
        </div>
      </div>

      {/* Inhalt rendern */}
      <div class="prose prose-lg text-gray-700 max-w-none prose-headings:text-blue-900 prose-a:text-blue-600" set:html={event.description}></div>

      <div class="mt-12 pt-8 border-t flex justify-between items-center flex-wrap gap-4">
        <a href="/" class="text-gray-600 hover:text-blue-600 font-medium transition flex items-center gap-2">
          â† ZurÃ¼ck zur Ãœbersicht
        </a>
        
        {event.pretix_link && (
          <a href={event.pretix_link} target="_blank" rel="noopener noreferrer" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition shadow-md">
            ğŸŸï¸ Tickets kaufen
          </a>
        )}
      </div>
    </div>
  </article>
</Layout>