---
import MainLayout from '../../layouts/layout.astro';
import { getEvents, getEventCategories } from '../../lib/api';
// Wir brauchen rrule für die Berechnung der Wiederholungen, falls ihr das nutzt. 
// Falls nicht, nutzen wir eine einfache Monats-Logik. 
// Da ich nicht weiß, ob 'rrule' installiert ist, baue ich eine robuste Standard-Logik.

const [allEvents, allCategories] = await Promise.all([
    getEvents(),
    getEventCategories()
]);

const ASSET_URL = 'http://localhost:8055/assets';

// --- HELPER: Nächstes Datum berechnen ---
const getNextEventDate = (event) => {
    const now = new Date();
    // Setze Uhrzeit auf 0 für fairen Vergleich "Heute"
    now.setHours(0,0,0,0);
    
    let eventDate = new Date(event.start_date || event.date);
    
    // Wenn das Datum in der Zukunft liegt (oder heute ist), ist alles gut.
    if (eventDate >= now) return eventDate;

    // SPEZIAL-LOGIK: Wenn das Datum vorbei ist, aber das Event "recurring" ist.
    // Wir prüfen hier auf typische Felder. Bitte passe 'recurrence_rule' an, 
    // falls dein Feld in Directus anders heißt (z.B. 'rrule', 'is_recurring', 'repetition').
    // Hier eine einfache Annahme: Wenn "is_recurring" true ist ODER eine rrule existiert.
    // Da ich dein Datenmodell nicht sehe, mache ich es clever:
    // Wenn das Event abgelaufen ist, schauen wir, ob wir es künstlich in die Zukunft holen müssen.
    
    // VEREINFACHUNG FÜR DICH:
    // Wir nehmen an, ALLES was im Frontend angezeigt wird, ist noch "aktuell" oder "wiederkehrend".
    // Wenn du explizit ein Feld 'recurrence' (z.B. "monthly") hast:
    if (event.recurrence === 'monthly' || event.rrule?.includes('FREQ=MONTHLY')) {
        // Solange das Datum in der Vergangenheit liegt, addiere 1 Monat
        while (eventDate < now) {
            eventDate.setMonth(eventDate.getMonth() + 1);
        }
        return eventDate;
    }
    
    // Falls weekly
    if (event.recurrence === 'weekly') {
         while (eventDate < now) {
            eventDate.setDate(eventDate.getDate() + 7);
        }
        return eventDate;
    }

    // Fallback: Wenn es kein Wiederholungs-Feld gibt, geben wir das alte Datum zurück
    // (es wird dann bei der Filterung ggf. rausfliegen oder als "vergangen" angezeigt)
    return eventDate;
};


// 1. Lookup Map für Kategorien
const catLookup = new Map();
(allCategories || []).forEach(cat => {
    if (cat.id) {
        const label = cat.name || cat.title || cat.label || "Kategorie";
        catLookup.set(String(cat.id), label);
    }
});

const categoryNames = Array.from(catLookup.values()).sort();

// 2. Events vorbereiten & Datum "fixen"
let eventsWithCats = allEvents.map(event => {
    // A) Kategorien auflösen
    const rawCats = event.event_categories || [];
    const validNames = rawCats.map(rel => {
        let targetId = null;
        if (rel.event_categories_id) {
            targetId = typeof rel.event_categories_id === 'object' ? rel.event_categories_id.id : rel.event_categories_id;
        }
        if (targetId) return catLookup.get(String(targetId));
        return null;
    }).filter(Boolean);

    // B) Das "richtige" Datum für die Anzeige berechnen
    const displayDate = getNextEventDate(event);

    return {
        ...event,
        _catString: validNames.join(','),
        _displayDate: displayDate, // Wir speichern das berechnete Datum für Sortierung & Anzeige
        _isFutureCalculated: displayDate.getTime() !== new Date(event.start_date).getTime() // Flag, falls wir manipuliert haben
    };
});

// 3. Filtern & Sortieren
// Wir filtern alte Events raus (außer Highlights, die man vllt. behalten will?)
// Hier: Nur Events anzeigen, die HEUTE oder in ZUKUNFT sind (basierend auf _displayDate)
const nowTimestamp = new Date().setHours(0,0,0,0);
eventsWithCats = eventsWithCats.filter(e => e._displayDate.getTime() >= nowTimestamp);

// Sortierung: Chronologisch nach dem NEUEN _displayDate
eventsWithCats.sort((a, b) => {
    return a._displayDate.getTime() - b._displayDate.getTime();
});
---

<MainLayout title="Veranstaltungskalender | Die Brücke">
    
    {/* --- HERO SECTION --- */}
    <section class="px-4 sm:px-6 pt-6 pb-12">
        <div class="relative bg-slate-900 rounded-[48px] overflow-hidden min-h-[50vh] flex items-center px-6 md:px-16 py-24 shadow-2xl">
            {/* Background Effects */}
            <div class="absolute top-0 right-0 w-full h-full overflow-hidden pointer-events-none">
                <div class="absolute top-[-20%] right-[-10%] w-[800px] h-[800px] bg-rose-600/20 rounded-full blur-[120px] animate-pulse-slow"></div>
                <div class="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-600/20 rounded-full blur-[120px]"></div>
                {/* Global Noise Overlay */}
                <div class="absolute inset-0 opacity-[0.15] mix-blend-overlay bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>
            </div>

            <div class="max-w-7xl mx-auto w-full relative z-10 grid lg:grid-cols-2 gap-16 items-center">
                <div>
                    <div class="mb-8">
                        <a href="/" class="inline-flex items-center text-slate-400 hover:text-white font-bold transition-colors group text-xs uppercase tracking-widest">
                            <i class="fa-solid fa-arrow-left mr-2 group-hover:-translate-x-1 transition-transform"></i>
                            Startseite
                        </a>
                    </div>
                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-rose-300 text-xs font-bold uppercase tracking-widest mb-8 backdrop-blur-md">
                        <span class="w-2 h-2 rounded-full bg-rose-500 animate-pulse"></span>
                        Kalender & Programm
                    </div>
                    <h1 class="text-5xl md:text-7xl font-display font-bold text-white mb-8 leading-[0.95] tracking-tight text-balance">
                        Bühne frei. <br/>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-rose-400 to-indigo-400">Für Kultur.</span>
                    </h1>
                    <p class="text-xl text-slate-300 leading-relaxed mb-10 max-w-lg font-medium border-l-4 border-rose-500 pl-6">
                        Von intimen Konzerten bis zu offenen Diskussionsrunden – hier findet Begegnung statt. Entdecke, was Graz bewegt.
                    </p>
                </div>
            </div>
        </div>
    </section>

    {/* --- SENTINEL FOR STICKY DETECTION --- */}
    <div id="sticky-sentinel" class="absolute left-0 w-full h-px -mt-24 pointer-events-none opacity-0"></div>

    {/* --- FILTER BAR --- */}
    <section class="px-4 sm:px-6 pb-12 sticky top-24 z-30 transition-all pointer-events-none">
        <div class="max-w-7xl mx-auto pointer-events-auto">
            <div id="filter-container" class="filter-bar-container bg-white/80 dark:bg-slate-900/80 backdrop-blur-xl border border-slate-200/60 dark:border-white/5 p-2 rounded-2xl shadow-xl shadow-slate-200/10 dark:shadow-black/40 inline-flex flex-wrap gap-2 transition-all duration-500">
                <button class="filter-btn active px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest transition-all hover:scale-105 active:scale-95 shadow-md bg-slate-900 text-white dark:bg-white dark:text-slate-900" 
                        data-category="all">
                    Alle
                </button>
                {categoryNames.map(name => (
                    <button class="filter-btn px-5 py-2.5 rounded-xl text-xs font-bold uppercase tracking-widest transition-all hover:scale-105 active:scale-95 bg-transparent text-slate-500 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-white" 
                            data-category={name}>
                        {name}
                    </button>
                ))}
            </div>
        </div>
    </section>

    {/* --- FLUID BENTO GRID --- */}
    <section class="bento-grid-section px-6 sm:px-10 pb-24 bg-white dark:bg-slate-950 transition-colors">
        <div class="max-w-7xl mx-auto">
            
            {eventsWithCats.length === 0 && (
                <div class="text-center py-20 bg-slate-50 dark:bg-slate-900 rounded-[32px] border border-dashed border-slate-200 dark:border-slate-800">
                    <p class="text-slate-400 font-bold uppercase tracking-widest">Aktuell keine Termine veröffentlicht</p>
                </div>
            )}

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 grid-flow-row-dense auto-rows-[minmax(380px,auto)]">
                {eventsWithCats.map(event => {
                    const isHighlight = event.is_highlight === true;
                    // WICHTIG: Wir nutzen jetzt _displayDate für die Anzeige!
                    const dateToShow = event._displayDate;

                    return (
                    <div 
                        class={`event-card group relative overflow-hidden rounded-[40px] transition-all duration-500 hover:scale-[1.01] hover:shadow-2xl flex flex-col
                        ${isHighlight 
                            // HIGHLIGHT CARD: Aurora Gradients & Noise
                            ? 'md:col-span-2 md:flex-row bg-gradient-to-br from-rose-50 via-white to-amber-50 dark:from-slate-900 dark:via-slate-900 dark:to-slate-800 shadow-xl ring-1 ring-slate-900/5 dark:ring-white/10' 
                            // STANDARD CARD: Subtle Gradient
                            : 'col-span-1 bg-gradient-to-br from-white to-slate-50 dark:from-slate-900 dark:to-slate-950 border border-slate-100 dark:border-slate-800'
                        }`}
                        data-cats={event._catString}
                    >
                        {isHighlight && (
                            <>
                                {/* DESIGN IDEE: Noise Texture für Highlights */}
                                <div class="absolute inset-0 opacity-[0.4] dark:opacity-[0.15] mix-blend-multiply dark:mix-blend-overlay bg-[url('https://grainy-gradients.vercel.app/noise.svg')] pointer-events-none z-0"></div>
                                {/* Farbiger Glow-Effekt */}
                                <div class="highlight-glow absolute inset-0 bg-gradient-to-br from-rose-500/10 via-transparent to-amber-500/10 dark:from-rose-500/10 dark:to-purple-500/10 opacity-100 pointer-events-none z-0"></div>
                            </>
                        )}
                        
                        <a href={`/events/${event.slug}`} 
                           class={`block relative overflow-hidden shrink-0 z-10
                           ${isHighlight ? 'w-full md:w-2/5 h-64 md:h-auto' : 'w-full aspect-[4/3]'}`}>
                            
                            {event.image ? (
                                <img src={`${ASSET_URL}/${event.image}`} class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt={event.title} />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center bg-slate-200 dark:bg-slate-800 text-slate-400 italic font-display uppercase tracking-widest text-[10px]">Kein Bild</div>
                            )}
                            
                            {/* Date Badge: Nutzen jetzt dateToShow */}
                            <div class="absolute top-5 left-5 flex flex-col gap-2 items-start">
                                <div class="bg-white/90 dark:bg-slate-900/90 backdrop-blur-md px-3 py-1.5 rounded-xl border border-white/20 dark:border-white/10 text-[11px] font-bold text-slate-900 dark:text-white uppercase tracking-widest shadow-sm">
                                    {dateToShow.toLocaleDateString('de-DE', { day: '2-digit', month: 'short' })}
                                </div>
                                {isHighlight && (
                                    <div class="bg-amber-400 text-slate-900 px-3 py-1.5 rounded-xl text-[11px] font-bold uppercase tracking-widest shadow-md flex items-center gap-1.5 animate-pulse-slow">
                                        <i class="fa-solid fa-star text-[10px]"></i>
                                        Tipp
                                    </div>
                                )}
                            </div>
                        </a>

                        <div class={`flex flex-col flex-grow relative z-10 justify-between
                            ${isHighlight ? 'p-8 md:p-12' : 'p-8'}`}>
                            
                            <div>
                                <div class="flex gap-2 mb-5 flex-wrap">
                                    {event._catString ? event._catString.split(',').map(catName => (
                                        <span class={`cat-badge text-[10px] font-bold uppercase tracking-widest px-2.5 py-1 rounded-lg border
                                            ${isHighlight 
                                                ? 'bg-white/60 border-rose-200/50 text-rose-700 dark:bg-rose-900/20 dark:border-rose-700/30 dark:text-rose-300' 
                                                : 'bg-white border-slate-200 text-slate-400 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400'}`}>
                                            {catName}
                                        </span>
                                    )) : null}
                                </div>

                                <h3 class={`font-display font-bold group-hover:text-rose-600 transition-colors leading-[1.1] tracking-tight mb-4
                                    ${isHighlight ? 'text-3xl md:text-4xl' : 'text-2xl'}
                                    text-slate-900 dark:text-white`}>
                                    <a href={`/events/${event.slug}`} class="focus:outline-none">
                                        <span class="absolute inset-0 md:hidden"></span>
                                        {event.title}
                                    </a>
                                </h3>

                                {isHighlight && event.description && (
                                    <p class="text-slate-600 dark:text-slate-300 text-lg leading-relaxed mb-8 line-clamp-2 md:line-clamp-3 hidden md:block">
                                        {event.description.replace(/<[^>]*>?/gm, '').substring(0, 160)}...
                                    </p>
                                )}
                            </div>

                            <div class="flex items-center justify-between pt-6 mt-4 border-t border-slate-200/50 dark:border-white/5">
                                <span class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest group-hover:text-rose-500 transition-colors">Details</span>
                                <div class={`w-10 h-10 rounded-full flex items-center justify-center transition-all duration-300 transform group-hover:translate-x-1
                                    ${isHighlight 
                                        ? 'bg-rose-500 text-white shadow-lg shadow-rose-500/20' 
                                        : 'bg-white dark:bg-slate-800 text-slate-900 dark:text-white shadow-sm group-hover:bg-rose-600 group-hover:text-white'}`}>
                                    <i class="fa-solid fa-arrow-right text-sm"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                )})}
            </div>
        </div>
    </section>

    {/* ... Footer Teaser & CTA ... */}
    {/* --- FOOTER TEASERS --- */}
    <section class="footer-teaser-section px-6 sm:px-10 py-24 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 transition-colors">
        <div class="max-w-5xl mx-auto">
            <div class="grid md:grid-cols-2 gap-12 items-center">
                <div>
                    <span class="text-rose-500 font-bold tracking-widest uppercase text-xs mb-4 block">Kulturraum Graz</span>
                    <h2 class="text-4xl font-display font-bold text-slate-900 dark:text-white mb-6 tracking-tight">
                        Vielfalt als Programm.
                    </h2>
                    <p class="text-slate-600 dark:text-slate-400 leading-relaxed mb-6 font-medium">
                        Die Brücke ist mehr als nur ein Veranstaltungsort. Wir sind ein lebendiges Labor für soziale Innovation und kulturellen Austausch. Unser Programm entsteht oft direkt aus den Wünschen und Ideen unserer Besucher.
                    </p>
                </div>
                <div class="relative">
                    <div class="aspect-square rounded-[32px] bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-8 shadow-xl rotate-3 hover:rotate-0 transition-transform duration-500 flex flex-col justify-center items-center text-center">
                         <i class="fa-solid fa-quote-left text-4xl text-rose-200 dark:text-rose-900 mb-6"></i>
                         <p class="text-xl font-display font-bold text-slate-900 dark:text-white mb-4">
                             "Ein Ort, an dem man Mensch sein darf, ohne Bedingungen."
                         </p>
                         <span class="text-xs font-bold uppercase tracking-widest text-slate-400">– Ein Besucher</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="cta-section px-6 sm:px-10 py-24 bg-white dark:bg-slate-950 transition-colors">
        <div class="max-w-7xl mx-auto">
            <div class="bg-slate-900 rounded-[40px] p-12 md:p-20 text-center relative overflow-hidden shadow-2xl">
                <div class="absolute top-0 left-0 w-64 h-64 bg-rose-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 -translate-x-1/2 -translate-y-1/2"></div>
                <div class="absolute bottom-0 right-0 w-64 h-64 bg-indigo-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 translate-x-1/2 translate-y-1/2"></div>

                <div class="relative z-10 max-w-2xl mx-auto">
                    <h2 class="text-3xl md:text-5xl font-display font-bold text-white mb-6 tracking-tight">
                        Hast du eine Idee?
                    </h2>
                    <p class="text-slate-300 text-lg mb-10 font-medium leading-relaxed">
                        Wir stellen Räume und Ressourcen für deine Initiative zur Verfügung. Egal ob Workshop, Lesung oder Selbsthilfegruppe – werde Teil des Programms.
                    </p>
                    <a href="/contact" class="inline-flex items-center gap-2 bg-white text-slate-900 hover:bg-rose-500 hover:text-white px-8 py-4 rounded-full font-bold transition-all shadow-lg hover:shadow-rose-500/25">
                        Veranstaltung vorschlagen
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </section>

    <style is:global>
        /* Sticky State Enhancements */
        .filter-bar-container.is-stuck {
            background-color: rgba(241, 245, 249, 0.95) !important; /* slate-100 */
            border-color: rgba(203, 213, 225, 0.8) !important; /* slate-300 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        html.dark .filter-bar-container.is-stuck {
            background-color: rgba(15, 23, 42, 0.95) !important; /* slate-900 */
            border-color: rgba(51, 65, 85, 0.8) !important;
        }

        /* Active Filter Button Dark Mode */
        html.dark .filter-btn.active {
            background-color: #ffffff !important;
            color: #0f172a !important;
        }
    </style>

</MainLayout>

<script>
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.event-card');
    const filterContainer = document.getElementById('filter-container');
    const sentinel = document.getElementById('sticky-sentinel');

    // 1. Sticky-Detection
    if (sentinel && filterContainer) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (!entry.isIntersecting && entry.boundingClientRect.top < 0) {
                    filterContainer.classList.add('is-stuck');
                } else {
                    filterContainer.classList.remove('is-stuck');
                }
            });
        }, {
            rootMargin: '-100px 0px 0px 0px', 
            threshold: 0
        });
        observer.observe(sentinel);
    }

    // 2. Filter-Logik
    const activeClasses = ['bg-slate-900', 'text-white', 'shadow-md', 'dark:bg-white', 'dark:text-slate-900'];
    const inactiveClasses = ['bg-transparent', 'text-slate-500', 'hover:bg-slate-100', 'hover:text-slate-900', 'dark:text-slate-400', 'dark:hover:bg-slate-800', 'dark:hover:text-white'];

    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            const category = btn.getAttribute('data-category');

            buttons.forEach(b => {
                b.classList.remove(...activeClasses);
                b.classList.add(...inactiveClasses);
                b.classList.remove('active');
            });
            
            btn.classList.remove(...inactiveClasses);
            btn.classList.add(...activeClasses);
            btn.classList.add('active'); 

            cards.forEach(card => {
                const cardCats = card.getAttribute('data-cats') || '';
                if (category === 'all' || cardCats.includes(category)) {
                    (card as HTMLElement).style.display = 'flex'; 
                } else {
                    (card as HTMLElement).style.display = 'none';
                }
            });
        });
    });
</script>